name: Ubuntu XFCE VNC Server

on:
  workflow_dispatch:

jobs:
  ubuntu-vnc:
    runs-on: ubuntu-24.04-arm   # ARM64 runner
    timeout-minutes: 360   # Correct max runtime
    env:
      VNC_PASSWORD_SECRET: ${{ secrets.VNC_PASSWORD }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache APT packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('.github/workflows/apt-packages.txt') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Add ngrok repository
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list

      - name: Update APT and install dependencies
        run: |
          sudo apt-get update
          xargs -a .github/workflows/apt-packages.txt sudo apt-get install -y

      - name: Configure VNC
        run: |
          mkdir -p ~/.vnc
          touch ~/.Xauthority
          chmod 600 ~/.Xauthority
          if [ -n "$VNC_PASSWORD_SECRET" ]; then
            echo "$VNC_PASSWORD_SECRET" | vncpasswd -f > ~/.vnc/passwd
          else
            echo "vncpassword" | vncpasswd -f > ~/.vnc/passwd
          fi
          chmod 600 ~/.vnc/passwd
          cat > ~/.vnc/xstartup << 'EOF'
          #!/bin/bash
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          exec startxfce4
          EOF
          chmod +x ~/.vnc/xstartup
          vncserver -kill :0 || true
          vncserver :0 -geometry 1280x1024 -depth 24 -SecurityTypes VncAuth -PasswordFile ~/.vnc/passwd -localhost no
          
          # Fix permissions for Snap apps
          export DISPLAY=:0
          xhost +
          
          # Create Chromium Desktop Shortcut
          mkdir -p ~/Desktop
          mkdir -p ~/.local/share/applications
          cat > ~/Desktop/chromium.desktop <<EOF
          [Desktop Entry]
          Version=1.0
          Name=Chromium Web Browser
          Comment=Access the Internet
          Exec=bash -c "export DISPLAY=:0 && chromium-browser --no-sandbox"
          Icon=chromium-browser
          Terminal=false
          Type=Application
          Categories=Network;WebBrowser;
          EOF
          chmod +x ~/Desktop/chromium.desktop
          cp ~/Desktop/chromium.desktop ~/.local/share/applications/

      - name: Install Tailscale (optional)
        if: ${{ env.TAILSCALE_AUTH_KEY != '' }}
        run: curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start tailscaled (optional)
        if: ${{ env.TAILSCALE_AUTH_KEY != '' }}
        run: |
          sudo mkdir -p /var/run
          sudo nohup tailscaled >/tmp/tailscaled.log 2>&1 &
          sleep 3

      - name: Connect to Tailscale (optional)
        if: ${{ env.TAILSCALE_AUTH_KEY != '' }}
        run: |
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname=gh-runner-${GITHUB_RUN_ID}
          echo "TAILSCALE_IP=$(tailscale ip -4)" >> "$GITHUB_ENV"

      - name: Verify Tailscale VNC (optional)
        if: ${{ env.TAILSCALE_IP != '' }}
        run: nc -vz "$TAILSCALE_IP" 5900

      - name: Start Ngrok tunnel (optional)
        env:
          NGROK_AUTH_TOKEN_CHECK: ${{ env.NGROK_AUTH_TOKEN }}
        if: ${{ env.NGROK_AUTH_TOKEN_CHECK != '' }}
        run: |
          ngrok authtoken "$NGROK_AUTH_TOKEN"
          nohup ngrok tcp 5900 >/tmp/ngrok.log 2>&1 &
          NGROK_PID=$!
          echo $NGROK_PID > ngrok.pid
          for i in {1..10}; do
            TUNNEL_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
            if [ -n "$TUNNEL_URL" ] && [ "$TUNNEL_URL" != "null" ]; then
              echo $TUNNEL_URL > ngrok.txt
              echo "NGROK_TUNNEL=$TUNNEL_URL" >> "$GITHUB_ENV"
              break
            fi
            sleep 2
          done

      - name: Check Ngrok tunnel reachability (optional)
        if: ${{ env.NGROK_TUNNEL != '' }}
        run: |
          HOSTPORT=${NGROK_TUNNEL#tcp://}
          HOST=${HOSTPORT%:*}
          PORT=${HOSTPORT##*:}
          if nc -z -w 5 "$HOST" "$PORT"; then
            echo "Ngrok tunnel is reachable from the runner"
          else
            echo "WARNING: Unable to reach ngrok tunnel from the runner" >&2
          fi

      - name: Save connection info
        run: |
          PUBLIC_IP=$(curl -s ifconfig.me)
          if [ -n "$VNC_PASSWORD_SECRET" ]; then
            echo "VNC Password: $VNC_PASSWORD_SECRET" > connection-info.txt
          else
            echo "VNC Password: vncpassword" > connection-info.txt
          fi
          echo "VNC Address: $PUBLIC_IP:5900" >> connection-info.txt
          echo "WARNING: The VNC Address might not be accessible from the internet due to firewall restrictions." >> connection-info.txt
          echo "It is recommended to use the Ngrok Tunnel for a reliable connection." >> connection-info.txt
          if [ -f ngrok.txt ]; then
            echo "Ngrok Tunnel: $(cat ngrok.txt)" >> connection-info.txt
          fi
          if [ -n "$TAILSCALE_IP" ]; then
            echo "Tailscale IP: ${TAILSCALE_IP}:5900" >> connection-info.txt
          fi

      - name: Upload connection info artifact
        uses: actions/upload-artifact@v4
        with:
          name: vnc-connection-info
          path: connection-info.txt

      - name: Keep alive with cleanup trap
        run: |
          trap 'vncserver -kill :0; if [ -f ngrok.pid ]; then kill $(cat ngrok.pid) 2>/dev/null || true; fi; sudo pkill tailscaled 2>/dev/null || true; sudo pkill tailscale 2>/dev/null || true' EXIT
          while true; do
            echo "[$(date)] VNC Active - Cancel workflow to terminate"
            sleep 300
          done
