name: Ubuntu XFCE VNC Server

on:
  workflow_dispatch:

jobs:
  ubuntu-vnc:
    runs-on: ubuntu-24.04
    timeout-minutes: 360   # Correct max runtime

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache APT packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('.github/workflows/apt-packages.txt') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Add ngrok repository
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list

      - name: Update APT and install dependencies
        run: |
          sudo apt-get update
          xargs -a .github/workflows/apt-packages.txt sudo apt-get install -y

      - name: Configure VNC
        run: |
          mkdir -p ~/.vnc
          if [ -n "${{ secrets.VNC_PASSWORD }}" ]; then
            echo "${{ secrets.VNC_PASSWORD }}" | vncpasswd -f > ~/.vnc/passwd
          else
            echo "vncpassword" | vncpasswd -f > ~/.vnc/passwd
          fi
          chmod 600 ~/.vnc/passwd
          cat > ~/.vnc/xstartup << 'EOF'
          #!/bin/bash
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          startxfce4 &
          EOF
          chmod +x ~/.vnc/xstartup
          vncserver -kill :0 || true
          vncserver :0 -geometry 1280x800 -depth 24 -xstartup ~/.vnc/xstartup

      - name: Start Ngrok tunnel (optional)
        env:
          NGROK_AUTH_TOKEN_CHECK: ${{ secrets.NGROK_AUTH_TOKEN }}
        if: ${{ env.NGROK_AUTH_TOKEN_CHECK != '' }}
        run: |
          ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          ngrok tcp 5900 &
          for i in {1..10}; do
            TUNNEL_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
            if [ -n "$TUNNEL_URL" ] && [ "$TUNNEL_URL" != "null" ]; then
              echo $TUNNEL_URL > ngrok.txt
              break
            fi
            sleep 2
          done

      - name: Save connection info
        run: |
          if [ -n "${{ secrets.VNC_PASSWORD }}" ]; then
            echo "VNC Password: ${{ secrets.VNC_PASSWORD }}" > connection-info.txt
          else
            echo "VNC Password: vncpassword" > connection-info.txt
          fi
          echo "Local VNC: localhost:5900" >> connection-info.txt
          if [ -f ngrok.txt ]; then
            echo "Ngrok Tunnel: $(cat ngrok.txt)" >> connection-info.txt
          fi

      - name: Upload connection info artifact
        uses: actions/upload-artifact@v4
        with:
          name: vnc-connection-info
          path: connection-info.txt

      - name: Keep alive with cleanup trap
        run: |
          trap "vncserver -kill :0; pkill ngrok" EXIT
          while true; do
            echo "[$(date)] VNC Active - Cancel workflow to terminate"
            sleep 300
          done
